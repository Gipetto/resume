{"version":3,"file":"qWShZZ1Y.js","sources":["../../../../../../node_modules/svelte/src/internal/client/dom/blocks/branches.js"],"sourcesContent":["/** @import { Effect, TemplateNode } from '#client' */\nimport { Batch, current_batch } from '../../reactivity/batch.js';\nimport {\n\tbranch,\n\tdestroy_effect,\n\tmove_effect,\n\tpause_effect,\n\tresume_effect\n} from '../../reactivity/effects.js';\nimport { hydrate_node, hydrating } from '../hydration.js';\nimport { create_text, should_defer_append } from '../operations.js';\n\n/**\n * @typedef {{ effect: Effect, fragment: DocumentFragment }} Branch\n */\n\n/**\n * @template Key\n */\nexport class BranchManager {\n\t/** @type {TemplateNode} */\n\tanchor;\n\n\t/** @type {Map<Batch, Key>} */\n\t#batches = new Map();\n\n\t/**\n\t * Map of keys to effects that are currently rendered in the DOM.\n\t * These effects are visible and actively part of the document tree.\n\t * Example:\n\t * ```\n\t * {#if condition}\n\t * \tfoo\n\t * {:else}\n\t * \tbar\n\t * {/if}\n\t * ```\n\t * Can result in the entries `true->Effect` and `false->Effect`\n\t * @type {Map<Key, Effect>}\n\t */\n\t#onscreen = new Map();\n\n\t/**\n\t * Similar to #onscreen with respect to the keys, but contains branches that are not yet\n\t * in the DOM, because their insertion is deferred.\n\t * @type {Map<Key, Branch>}\n\t */\n\t#offscreen = new Map();\n\n\t/**\n\t * Keys of effects that are currently outroing\n\t * @type {Set<Key>}\n\t */\n\t#outroing = new Set();\n\n\t/**\n\t * Whether to pause (i.e. outro) on change, or destroy immediately.\n\t * This is necessary for `<svelte:element>`\n\t */\n\t#transition = true;\n\n\t/**\n\t * @param {TemplateNode} anchor\n\t * @param {boolean} transition\n\t */\n\tconstructor(anchor, transition = true) {\n\t\tthis.anchor = anchor;\n\t\tthis.#transition = transition;\n\t}\n\n\t#commit = () => {\n\t\tvar batch = /** @type {Batch} */ (current_batch);\n\n\t\t// if this batch was made obsolete, bail\n\t\tif (!this.#batches.has(batch)) return;\n\n\t\tvar key = /** @type {Key} */ (this.#batches.get(batch));\n\n\t\tvar onscreen = this.#onscreen.get(key);\n\n\t\tif (onscreen) {\n\t\t\t// effect is already in the DOM â€” abort any current outro\n\t\t\tresume_effect(onscreen);\n\t\t\tthis.#outroing.delete(key);\n\t\t} else {\n\t\t\t// effect is currently offscreen. put it in the DOM\n\t\t\tvar offscreen = this.#offscreen.get(key);\n\n\t\t\tif (offscreen) {\n\t\t\t\tthis.#onscreen.set(key, offscreen.effect);\n\t\t\t\tthis.#offscreen.delete(key);\n\n\t\t\t\t// remove the anchor...\n\t\t\t\t/** @type {TemplateNode} */ (offscreen.fragment.lastChild).remove();\n\n\t\t\t\t// ...and append the fragment\n\t\t\t\tthis.anchor.before(offscreen.fragment);\n\t\t\t\tonscreen = offscreen.effect;\n\t\t\t}\n\t\t}\n\n\t\tfor (const [b, k] of this.#batches) {\n\t\t\tthis.#batches.delete(b);\n\n\t\t\tif (b === batch) {\n\t\t\t\t// keep values for newer batches\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tconst offscreen = this.#offscreen.get(k);\n\n\t\t\tif (offscreen) {\n\t\t\t\t// for older batches, destroy offscreen effects\n\t\t\t\t// as they will never be committed\n\t\t\t\tdestroy_effect(offscreen.effect);\n\t\t\t\tthis.#offscreen.delete(k);\n\t\t\t}\n\t\t}\n\n\t\t// outro/destroy all onscreen effects...\n\t\tfor (const [k, effect] of this.#onscreen) {\n\t\t\t// ...except the one that was just committed\n\t\t\t//    or those that are already outroing (else the transition is aborted and the effect destroyed right away)\n\t\t\tif (k === key || this.#outroing.has(k)) continue;\n\n\t\t\tconst on_destroy = () => {\n\t\t\t\tconst keys = Array.from(this.#batches.values());\n\n\t\t\t\tif (keys.includes(k)) {\n\t\t\t\t\t// keep the effect offscreen, as another batch will need it\n\t\t\t\t\tvar fragment = document.createDocumentFragment();\n\t\t\t\t\tmove_effect(effect, fragment);\n\n\t\t\t\t\tfragment.append(create_text()); // TODO can we avoid this?\n\n\t\t\t\t\tthis.#offscreen.set(k, { effect, fragment });\n\t\t\t\t} else {\n\t\t\t\t\tdestroy_effect(effect);\n\t\t\t\t}\n\n\t\t\t\tthis.#outroing.delete(k);\n\t\t\t\tthis.#onscreen.delete(k);\n\t\t\t};\n\n\t\t\tif (this.#transition || !onscreen) {\n\t\t\t\tthis.#outroing.add(k);\n\t\t\t\tpause_effect(effect, on_destroy, false);\n\t\t\t} else {\n\t\t\t\ton_destroy();\n\t\t\t}\n\t\t}\n\t};\n\n\t/**\n\t * @param {Batch} batch\n\t */\n\t#discard = (batch) => {\n\t\tthis.#batches.delete(batch);\n\n\t\tconst keys = Array.from(this.#batches.values());\n\n\t\tfor (const [k, branch] of this.#offscreen) {\n\t\t\tif (!keys.includes(k)) {\n\t\t\t\tdestroy_effect(branch.effect);\n\t\t\t\tthis.#offscreen.delete(k);\n\t\t\t}\n\t\t}\n\t};\n\n\t/**\n\t *\n\t * @param {any} key\n\t * @param {null | ((target: TemplateNode) => void)} fn\n\t */\n\tensure(key, fn) {\n\t\tvar batch = /** @type {Batch} */ (current_batch);\n\t\tvar defer = should_defer_append();\n\n\t\tif (fn && !this.#onscreen.has(key) && !this.#offscreen.has(key)) {\n\t\t\tif (defer) {\n\t\t\t\tvar fragment = document.createDocumentFragment();\n\t\t\t\tvar target = create_text();\n\n\t\t\t\tfragment.append(target);\n\n\t\t\t\tthis.#offscreen.set(key, {\n\t\t\t\t\teffect: branch(() => fn(target)),\n\t\t\t\t\tfragment\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis.#onscreen.set(\n\t\t\t\t\tkey,\n\t\t\t\t\tbranch(() => fn(this.anchor))\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\n\t\tthis.#batches.set(batch, key);\n\n\t\tif (defer) {\n\t\t\tfor (const [k, effect] of this.#onscreen) {\n\t\t\t\tif (k === key) {\n\t\t\t\t\tbatch.skipped_effects.delete(effect);\n\t\t\t\t} else {\n\t\t\t\t\tbatch.skipped_effects.add(effect);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (const [k, branch] of this.#offscreen) {\n\t\t\t\tif (k === key) {\n\t\t\t\t\tbatch.skipped_effects.delete(branch.effect);\n\t\t\t\t} else {\n\t\t\t\t\tbatch.skipped_effects.add(branch.effect);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tbatch.oncommit(this.#commit);\n\t\t\tbatch.ondiscard(this.#discard);\n\t\t} else {\n\t\t\tif (hydrating) {\n\t\t\t\tthis.anchor = hydrate_node;\n\t\t\t}\n\n\t\t\tthis.#commit();\n\t\t}\n\t}\n}\n"],"names":["BranchManager","#batches","#onscreen","#offscreen","#outroing","#transition","anchor","transition","#commit","batch","current_batch","key","onscreen","resume_effect","offscreen","b","k","destroy_effect","effect","on_destroy","fragment","move_effect","create_text","pause_effect","#discard","keys","branch","fn","defer","should_defer_append","target","hydrating","hydrate_node"],"mappings":"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","x_google_ignoreList":[0]}